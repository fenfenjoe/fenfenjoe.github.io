import{_ as n,c as a,a as e,o as p}from"./app-Dz2xZzfz.js";const l={};function t(c,s){return p(),a("div",null,s[0]||(s[0]=[e(`<h1 id="hive学习笔记" tabindex="-1"><a class="header-anchor" href="#hive学习笔记"><span>Hive学习笔记</span></a></h1><h2 id="参考" tabindex="-1"><a class="header-anchor" href="#参考"><span>参考</span></a></h2><p>【Hive Wiki（维基百科，英文）】 <a href="https://cwiki.apache.org/confluence/display/HIVE" target="_blank" rel="noopener noreferrer">https://cwiki.apache.org/confluence/display/HIVE</a></p><h2 id="简介" tabindex="-1"><a class="header-anchor" href="#简介"><span>简介</span></a></h2><p>简单来说，Hive可以理解为一个<strong>将SQL转换MapReduce的任务</strong>的工具。</p><p>甚至更进一步，可以说hive就是一个MapReduce的客户端。</p><p>Hive能让用户感觉自己在操作关系型数据库（Mysql、Oracle），让学习、编写<strong>查询任务</strong>成本大大降低。</p><p>Hive是基于Hadoop的一个数据仓库工具，可以将结构化的数据文件映射为一张数据库表，并提供类SQL查询功能。</p><p>其本质是将SQL转换为MapReduce的任务进行运算，底层由HDFS来提供数据的存储。</p><h2 id="结构" tabindex="-1"><a class="header-anchor" href="#结构"><span>结构</span></a></h2><p>与mysql结构类似，可创建数据库、创建表；不同的是Hive中，表以下多了“分区”、“桶”这些概念；</p><p><strong>分区：</strong> 表中每行数据通过“分区字段”表明自己属于哪个分区；但分区字段实际上不保存数据。</p><p><strong>桶：</strong> 表中每行数据通过“分桶字段”表明自己属于哪个桶；分桶字段是实实在在存在的表中的字段，会先求出字段的哈希值，然后除以桶数求余来确定属于哪个桶。</p><h2 id="hdfs" tabindex="-1"><a class="header-anchor" href="#hdfs"><span>HDFS</span></a></h2><p>Hive就是从HDFS集群中存取数据的一个工具，因此了解HDFS对我们学习Hive有一定帮助。 详细见“Hadoop学习笔记”。</p><h2 id="hive的数据类型" tabindex="-1"><a class="header-anchor" href="#hive的数据类型"><span>Hive的数据类型</span></a></h2><p><strong>原始类型</strong></p><p>Integers（整型）</p><ul><li>TINYINT －1位的整型</li><li>SMALLINT －2位的整型</li><li>INT －4位的整型</li><li>BIGINT －8位的整型</li></ul><p>布尔类型</p><ul><li>BOOLEAN －TRUE/FALSE</li></ul><p>浮点数</p><ul><li>FLOAT －单精度</li><li>DOUBLE －双精度定点数</li><li>DECIMAL －用户可以指定范围和小数点位数</li></ul><p>字符串</p><ul><li>STRING －在特定的字符集中的一个字符串序列</li><li>VARCHAR －在特定的字符集中的一个有最大长度限制的字符串序列</li><li>CHAR －在特定的字符集中的一个指定长度的字符串序列</li></ul><p>日期和时间</p><ul><li>TIMESTAMP －一个特定的时间点，精确到纳秒。</li><li>DATE －一个日期</li></ul><p>二进制</p><ul><li>BINARY －一个二进制位序列</li></ul><p><strong>复杂类型</strong></p><p>结构体类型（struct）</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code class="language-sql"><span class="line"><span class="token comment">#定义</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test<span class="token punctuation">(</span></span>
<span class="line">name STRING<span class="token punctuation">,</span></span>
<span class="line">test_struct STRUCT<span class="token operator">&lt;</span>course STRING<span class="token punctuation">,</span>score <span class="token keyword">INT</span><span class="token operator">&gt;</span></span>
<span class="line"><span class="token keyword">ROW</span> FORMAT DELIMITED </span>
<span class="line"><span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">&#39;\\t&#39;</span> <span class="token comment">#字段之间通过制表符隔开</span></span>
<span class="line">COLLECTION <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">&#39;,&#39;</span> <span class="token comment">#数组、结构体之间通过逗号隔开</span></span>
<span class="line">MAP <span class="token keyword">KEY</span> TERMIATED <span class="token keyword">BY</span> <span class="token string">&#39;:&#39;</span> <span class="token comment">#map的key和value通过冒号隔开</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">#插入的数据格式如下：</span></span>
<span class="line">张三 语文:<span class="token number">90</span></span>
<span class="line">张三 数学:<span class="token number">85</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">#访问</span></span>
<span class="line"><span class="token keyword">SELECT</span> t<span class="token punctuation">.</span>test_struct<span class="token punctuation">.</span>course <span class="token keyword">FROM</span> test<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>数组类型(array)</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code class="language-sql"><span class="line"><span class="token comment">#定义</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test<span class="token punctuation">(</span></span>
<span class="line">test_arr ARRAY<span class="token operator">&lt;</span><span class="token keyword">INT</span><span class="token operator">&gt;</span></span>
<span class="line"><span class="token keyword">ROW</span> FORMAT DELIMITED </span>
<span class="line"><span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">&#39;\\t&#39;</span> <span class="token comment">#字段之间通过制表符隔开</span></span>
<span class="line">COLLECTION <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">&#39;,&#39;</span> <span class="token comment">#数组、结构体之间通过逗号隔开</span></span>
<span class="line">MAP <span class="token keyword">KEY</span> TERMIATED <span class="token keyword">BY</span> <span class="token string">&#39;:&#39;</span> <span class="token comment">#map的key和value通过冒号隔开</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">#插入的数据格式如下</span></span>
<span class="line"><span class="token comment">#1,2,3,4</span></span>
<span class="line"><span class="token comment">#2,5,10,14</span></span>
<span class="line"><span class="token comment">#访问</span></span>
<span class="line"><span class="token keyword">SELECT</span> t<span class="token punctuation">.</span>test_arr<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token keyword">FROM</span> test t<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Map类型</p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code class="language-sql"><span class="line"><span class="token comment">#定义</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> test<span class="token punctuation">(</span></span>
<span class="line">name STRING<span class="token punctuation">,</span></span>
<span class="line">score MAP<span class="token operator">&lt;</span>STRING<span class="token punctuation">,</span><span class="token keyword">INT</span><span class="token operator">&gt;</span></span>
<span class="line"><span class="token keyword">ROW</span> FORMAT DELIMITED </span>
<span class="line"><span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">&#39;\\t&#39;</span> <span class="token comment">#字段之间通过制表符隔开</span></span>
<span class="line">COLLECTION <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">&#39;,&#39;</span> <span class="token comment">#数组、结构体之间通过逗号隔开</span></span>
<span class="line">MAP <span class="token keyword">KEY</span> TERMIATED <span class="token keyword">BY</span> <span class="token string">&#39;:&#39;</span> <span class="token comment">#map的key和value通过冒号隔开</span></span>
<span class="line"><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">#插入的数据格式如下</span></span>
<span class="line"><span class="token comment">#王强  &#39;语文&#39;:80,&#39;数学&#39;:&#39;100&#39;,英语:&#39;95&#39;</span></span>
<span class="line"><span class="token comment">#张三  &#39;语文&#39;:82,&#39;数学&#39;:&#39;100&#39;,英语:&#39;90&#39;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">#查询所有语文成绩</span></span>
<span class="line"><span class="token keyword">SELECT</span> name<span class="token punctuation">,</span>t<span class="token punctuation">.</span>score<span class="token punctuation">[</span><span class="token string">&quot;语文&quot;</span><span class="token punctuation">]</span> <span class="token keyword">from</span> test<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="hive-sql语法" tabindex="-1"><a class="header-anchor" href="#hive-sql语法"><span>Hive SQL语法</span></a></h2><p>Hive提供通过编写SQL的形式去查数据，称为<strong>Hive SQL</strong>；</p><p>而因为Hadoop是一个存储海量数据的分布式存储框架，数据存储在不同的机器上，因此Hive SQL语法会跟平时的关系型数据库（Mysql、Oracle）有所区别；</p><p>Hive SQL一般只用于查询，而且是离线查询。（不像Mysql实时返回数据，而是生成任务在后台查询，查出的数据再缓存起来）；</p><p>不支持对行级数据的增、删、改；</p><p><strong>创建表</strong></p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code class="language-sql"><span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> page_view<span class="token punctuation">(</span></span>
<span class="line">                viewTime <span class="token keyword">INT</span><span class="token punctuation">,</span> </span>
<span class="line">                userid <span class="token keyword">BIGINT</span><span class="token punctuation">,</span></span>
<span class="line">                page_url STRING<span class="token punctuation">,</span> </span>
<span class="line">                referrer_url STRING<span class="token punctuation">,</span></span>
<span class="line">                ip STRING <span class="token keyword">COMMENT</span> <span class="token string">&#39;IP Address of the User&#39;</span> <span class="token punctuation">)</span><span class="token comment">#列备注</span></span>
<span class="line"><span class="token keyword">COMMENT</span> <span class="token string">&#39;This is the page view table&#39;</span> <span class="token comment">#表备注</span></span>
<span class="line">PARTITIONED <span class="token keyword">BY</span><span class="token punctuation">(</span>dt STRING<span class="token punctuation">,</span> country STRING<span class="token punctuation">)</span> <span class="token comment">#分区字段</span></span>
<span class="line"><span class="token keyword">CLUSTERED</span> <span class="token keyword">BY</span><span class="token punctuation">(</span>userid<span class="token punctuation">)</span> SORTED <span class="token keyword">BY</span><span class="token punctuation">(</span>viewTime<span class="token punctuation">)</span> <span class="token keyword">INTO</span> <span class="token number">32</span> BUCKETS <span class="token comment">#分桶字段</span></span>
<span class="line"><span class="token keyword">ROW</span> FORMAT DELIMITED</span>
<span class="line">        <span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">&#39;1&#39;</span> <span class="token comment">#字段与字段之间的分隔符</span></span>
<span class="line">        COLLECTION ITEMS <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">&#39;2&#39;</span> <span class="token comment">#复杂类型(array，struct)字段的各个item之间的分隔符</span></span>
<span class="line">        MAP <span class="token keyword">KEYS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">&#39;3&#39;</span> <span class="token comment">#复杂类型(map)中key value之间的分隔符</span></span>
<span class="line">STORED <span class="token keyword">AS</span> SEQUENCEFILE<span class="token punctuation">;</span> <span class="token comment">#表示以二进制形式存储在hdfs中</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">#创建表（拷贝某个表的结构）</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> phone_info_like <span class="token operator">LIKE</span> phone_info<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">#创建临时表</span></span>
<span class="line"><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> temp_info</span>
<span class="line"><span class="token keyword">AS</span></span>
<span class="line"><span class="token keyword">SELECT</span> id phone_id，name phone_name<span class="token punctuation">,</span>price </span>
<span class="line"><span class="token keyword">FROM</span> phone_infoSORT <span class="token keyword">BY</span> phone_id<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>查看表</strong></p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code class="language-sql"><span class="line"><span class="token keyword">SHOW</span> <span class="token keyword">TABLES</span><span class="token punctuation">;</span> <span class="token comment">#查看所有表</span></span>
<span class="line"><span class="token keyword">SHOW</span> <span class="token keyword">TABLES</span> <span class="token string">&#39;page.*&#39;</span><span class="token punctuation">;</span> <span class="token comment">#查看page数据库的所有表</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>查看特定表的信息</strong></p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code class="language-sql"><span class="line"></span>
<span class="line"><span class="token keyword">DESCRIBE</span> <span class="token keyword">EXTENDED</span> page_view<span class="token punctuation">;</span> <span class="token comment">#列出表的列和列的类型</span></span>
<span class="line"><span class="token keyword">DESCRIBE</span> page_view<span class="token punctuation">;</span> <span class="token comment">#列出表page_view的所有分区</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>删除表</strong></p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code class="language-sql"><span class="line"><span class="token comment">#删除表</span></span>
<span class="line"><span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> pv_users<span class="token punctuation">;</span></span>
<span class="line"><span class="token comment">#删除分区</span></span>
<span class="line"><span class="token keyword">ALTER</span> <span class="token keyword">TABLE</span> pv_users <span class="token keyword">DROP</span> <span class="token keyword">PARTITION</span> <span class="token punctuation">(</span>ds<span class="token operator">=</span><span class="token string">&#39;2016-08-08&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>加载数据</strong></p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code class="language-sql"><span class="line"><span class="token comment">#本地文件-&gt;Hive表（Load方式）</span></span>
<span class="line"><span class="token keyword">load</span> <span class="token keyword">data</span> <span class="token keyword">local</span> inpath <span class="token string">&#39;/home/xudong/xxx.txt&#39;</span> <span class="token keyword">into</span> <span class="token keyword">table</span> phone_info<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">#HDFS文件-&gt;Hive表（Load方式）</span></span>
<span class="line"><span class="token keyword">load</span> <span class="token keyword">data</span> inpath <span class="token string">&#39;/input/xxx.txt&#39;</span> overwrite <span class="token keyword">into</span> <span class="token keyword">table</span> phone_info<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">#HDFS文件-&gt;Hive表（Insert方式）</span></span>
<span class="line"><span class="token comment">#先创建一个外部表（本地文件系统）</span></span>
<span class="line"><span class="token keyword">CREATE</span> EXTERNAL <span class="token keyword">TABLE</span> page_view_stg<span class="token punctuation">(</span>viewTime <span class="token keyword">INT</span><span class="token punctuation">,</span> userid <span class="token keyword">BIGINT</span><span class="token punctuation">,</span> page_url STRING<span class="token punctuation">,</span> referrer_url STRING<span class="token punctuation">,</span> ip STRING <span class="token keyword">COMMENT</span> <span class="token string">&#39;IP Address of the User&#39;</span><span class="token punctuation">,</span> country STRING <span class="token keyword">COMMENT</span> <span class="token string">&#39;country of origination&#39;</span><span class="token punctuation">)</span> </span>
<span class="line"><span class="token keyword">COMMENT</span> <span class="token string">&#39;This is the staging page view table&#39;</span> </span>
<span class="line"><span class="token keyword">ROW</span> FORMAT DELIMITED </span>
<span class="line"><span class="token keyword">FIELDS</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">&#39;44&#39;</span> </span>
<span class="line"><span class="token keyword">LINES</span> <span class="token keyword">TERMINATED</span> <span class="token keyword">BY</span> <span class="token string">&#39;12&#39;</span> </span>
<span class="line">STORED <span class="token keyword">AS</span> TEXTFILE </span>
<span class="line">LOCATION <span class="token string">&#39;/user/data/staging/page_view&#39;</span><span class="token punctuation">;</span> </span>
<span class="line"><span class="token comment">#将本地文件添加到外部表中</span></span>
<span class="line">hadoop dfs <span class="token operator">-</span>put <span class="token operator">/</span>tmp<span class="token operator">/</span>pv_2016<span class="token operator">-</span><span class="token number">06</span><span class="token operator">-</span><span class="token number">08.</span>txt <span class="token operator">/</span><span class="token keyword">user</span><span class="token operator">/</span><span class="token keyword">data</span><span class="token operator">/</span>staging<span class="token operator">/</span>page_view </span>
<span class="line"><span class="token comment">#将外部表数据加载到Hadoop的page_view表的分区中</span></span>
<span class="line"><span class="token keyword">FROM</span> page_view_stg pvs</span>
<span class="line"><span class="token keyword">INSERT</span> OVERWRITE <span class="token keyword">TABLE</span> page_view <span class="token keyword">PARTITION</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">&#39;2016-06-08&#39;</span><span class="token punctuation">,</span> country<span class="token operator">=</span><span class="token string">&#39;US&#39;</span><span class="token punctuation">)</span> <span class="token keyword">SELECT</span> pvs<span class="token punctuation">.</span>viewTime<span class="token punctuation">,</span> pvs<span class="token punctuation">.</span>userid<span class="token punctuation">,</span> pvs<span class="token punctuation">.</span>page_url<span class="token punctuation">,</span> pvs<span class="token punctuation">.</span>referrer_url<span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> pvs<span class="token punctuation">.</span>ip <span class="token keyword">WHERE</span> pvs<span class="token punctuation">.</span>country <span class="token operator">=</span> <span class="token string">&#39;US&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment">#Hive表-&gt;Hive表</span></span>
<span class="line"><span class="token comment">#将结果保存到Hive表user_active中</span></span>
<span class="line"><span class="token comment">#INTO是追加数据、OVERWRITE是覆盖数据</span></span>
<span class="line"><span class="token keyword">INSERT</span> OVERWRITE <span class="token keyword">TABLE</span> user_active</span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token keyword">user</span><span class="token punctuation">.</span><span class="token operator">*</span></span>
<span class="line"><span class="token keyword">FROM</span> <span class="token keyword">user</span></span>
<span class="line"><span class="token keyword">WHERE</span> <span class="token keyword">user</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span class="token comment">#Hive表-&gt;Hive表（加载到某个分区）</span></span>
<span class="line"><span class="token keyword">FROM</span> page_view_stg pvs </span>
<span class="line"><span class="token keyword">INSERT</span> OVERWRITE <span class="token keyword">TABLE</span> page_view <span class="token keyword">PARTITION</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">&#39;2008-06-08&#39;</span><span class="token punctuation">,</span> country<span class="token operator">=</span><span class="token string">&#39;US&#39;</span><span class="token punctuation">)</span> <span class="token keyword">SELECT</span> pvs<span class="token punctuation">.</span>viewTime<span class="token punctuation">,</span> pvs<span class="token punctuation">.</span>userid<span class="token punctuation">,</span> pvs<span class="token punctuation">.</span>page_url<span class="token punctuation">,</span> pvs<span class="token punctuation">.</span>referrer_url<span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> pvs<span class="token punctuation">.</span>ip <span class="token keyword">WHERE</span> pvs<span class="token punctuation">.</span>country <span class="token operator">=</span> <span class="token string">&#39;US&#39;</span> </span>
<span class="line"></span>
<span class="line"><span class="token comment">#Hive表-&gt;Hive表（动态分区插入）</span></span>
<span class="line"><span class="token comment">#1. 此例中country为需要动态分区插入的列</span></span>
<span class="line"><span class="token comment">#2. PARTITION中country不用指定值；select中需要把country查出来</span></span>
<span class="line"><span class="token keyword">FROM</span> page_view_stg pvs</span>
<span class="line"><span class="token keyword">INSERT</span> OVERWRITE <span class="token keyword">TABLE</span> page_view <span class="token keyword">PARTITION</span><span class="token punctuation">(</span>dt<span class="token operator">=</span><span class="token string">&#39;2008-06-08&#39;</span><span class="token punctuation">,</span> country<span class="token punctuation">)</span></span>
<span class="line">       <span class="token keyword">SELECT</span> pvs<span class="token punctuation">.</span>viewTime<span class="token punctuation">,</span> pvs<span class="token punctuation">.</span>userid<span class="token punctuation">,</span> pvs<span class="token punctuation">.</span>page_url<span class="token punctuation">,</span> pvs<span class="token punctuation">.</span>referrer_url<span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> <span class="token boolean">null</span><span class="token punctuation">,</span> pvs<span class="token punctuation">.</span>ip<span class="token punctuation">,</span> pvs<span class="token punctuation">.</span>country</span>
<span class="line"></span>
<span class="line"><span class="token comment">#Hive表-&gt;Hive表、HDFS</span></span>
<span class="line"><span class="token keyword">FROM</span> pv_users </span>
<span class="line"><span class="token keyword">INSERT</span> OVERWRITE <span class="token keyword">TABLE</span> pv_gender_sum <span class="token keyword">SELECT</span> pv_users<span class="token punctuation">.</span>gender<span class="token punctuation">,</span> count_distinct<span class="token punctuation">(</span>pv_users<span class="token punctuation">.</span>userid<span class="token punctuation">)</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> pv_users<span class="token punctuation">.</span>gender</span>
<span class="line"><span class="token keyword">INSERT</span> OVERWRITE DIRECTORY <span class="token string">&#39;/user/data/tmp/pv_age_sum&#39;</span> <span class="token keyword">SELECT</span> pv_users<span class="token punctuation">.</span>age<span class="token punctuation">,</span> count_distinct<span class="token punctuation">(</span>pv_users<span class="token punctuation">.</span>userid<span class="token punctuation">)</span> <span class="token keyword">GROUP</span> <span class="token keyword">BY</span> pv_users<span class="token punctuation">.</span>age<span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">#Hive表-&gt;本地文件</span></span>
<span class="line"><span class="token keyword">INSERT</span> OVERWRITE <span class="token keyword">LOCAL</span> DIRECTORY <span class="token string">&#39;/tmp/pv_gender_sum&#39;</span> </span>
<span class="line"><span class="token keyword">SELECT</span> pv_gender_sum<span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">FROM</span> pv_gender_sum<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>查询数据</strong></p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code class="language-sql"><span class="line"><span class="token comment">#将结果保存到Hive表user_active中</span></span>
<span class="line"><span class="token keyword">INSERT</span> OVERWRITE <span class="token keyword">TABLE</span> user_active</span>
<span class="line"><span class="token keyword">SELECT</span> <span class="token keyword">user</span><span class="token punctuation">.</span><span class="token operator">*</span></span>
<span class="line"><span class="token keyword">FROM</span> <span class="token keyword">user</span></span>
<span class="line"><span class="token keyword">WHERE</span> <span class="token keyword">user</span><span class="token punctuation">.</span>active <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">#将结果保存到HDFS中</span></span>
<span class="line"><span class="token keyword">INSERT</span> OVERWRITE DIRECTORY <span class="token string">&#39;/user/data/tmp/pv_age_sum&#39;</span> </span>
<span class="line"><span class="token keyword">SELECT</span> pv_users<span class="token punctuation">.</span>age<span class="token punctuation">,</span> count_distinct<span class="token punctuation">(</span>pv_users<span class="token punctuation">.</span>userid<span class="token punctuation">)</span> </span>
<span class="line"><span class="token keyword">GROUP</span> <span class="token keyword">BY</span> pv_users<span class="token punctuation">.</span>age<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>基于分区的查询</strong></p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code class="language-sql"><span class="line"><span class="token comment">#其中，date是page_views的一个分区字段</span></span>
<span class="line"><span class="token keyword">INSERT</span> OVERWRITE <span class="token keyword">TABLE</span> xyz_com_page_views</span>
<span class="line"><span class="token keyword">SELECT</span> page_views<span class="token punctuation">.</span><span class="token operator">*</span></span>
<span class="line"><span class="token keyword">FROM</span> page_views</span>
<span class="line"><span class="token keyword">WHERE</span> page_views<span class="token punctuation">.</span><span class="token keyword">date</span> <span class="token operator">&gt;=</span> <span class="token string">&#39;2008-03-01&#39;</span> <span class="token operator">AND</span> page_views<span class="token punctuation">.</span><span class="token keyword">date</span> <span class="token operator">&lt;=</span> <span class="token string">&#39;2008-03-31&#39;</span> <span class="token operator">AND</span></span>
<span class="line">      page_views<span class="token punctuation">.</span>referrer_url <span class="token operator">like</span> <span class="token string">&#39;%xyz.com&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>表连接</strong></p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code class="language-sql"><span class="line"><span class="token comment">#普通的内连接</span></span>
<span class="line"><span class="token keyword">INSERT</span> OVERWRITE <span class="token keyword">TABLE</span> pv_users</span>
<span class="line"><span class="token keyword">SELECT</span> pv<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> u<span class="token punctuation">.</span>gender<span class="token punctuation">,</span> u<span class="token punctuation">.</span>age</span>
<span class="line"><span class="token keyword">FROM</span> <span class="token keyword">user</span> u <span class="token keyword">JOIN</span> page_view pv <span class="token keyword">ON</span> <span class="token punctuation">(</span>pv<span class="token punctuation">.</span>userid <span class="token operator">=</span> u<span class="token punctuation">.</span>id<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">WHERE</span> pv<span class="token punctuation">.</span><span class="token keyword">date</span> <span class="token operator">=</span> <span class="token string">&#39;2008-03-03&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">#左连接</span></span>
<span class="line"><span class="token keyword">INSERT</span> OVERWRITE <span class="token keyword">TABLE</span> pv_users</span>
<span class="line"><span class="token keyword">SELECT</span> pv<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> u<span class="token punctuation">.</span>gender<span class="token punctuation">,</span> u<span class="token punctuation">.</span>age</span>
<span class="line"><span class="token keyword">FROM</span> <span class="token keyword">user</span> u <span class="token keyword">LEFT</span> <span class="token keyword">OUTER</span> <span class="token keyword">JOIN</span> page_view pv <span class="token keyword">ON</span> <span class="token punctuation">(</span>pv<span class="token punctuation">.</span>userid <span class="token operator">=</span> u<span class="token punctuation">.</span>id<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">WHERE</span> pv<span class="token punctuation">.</span><span class="token keyword">date</span> <span class="token operator">=</span> <span class="token string">&#39;2008-03-03&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">#返回user表中，id存在于page_view中的记录</span></span>
<span class="line"><span class="token keyword">INSERT</span> OVERWRITE <span class="token keyword">TABLE</span> pv_users</span>
<span class="line"><span class="token keyword">SELECT</span> u<span class="token punctuation">.</span><span class="token operator">*</span></span>
<span class="line"><span class="token keyword">FROM</span> <span class="token keyword">user</span> u <span class="token keyword">LEFT</span> SEMI <span class="token keyword">JOIN</span> page_view pv <span class="token keyword">ON</span> <span class="token punctuation">(</span>pv<span class="token punctuation">.</span>userid <span class="token operator">=</span> u<span class="token punctuation">.</span>id<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">WHERE</span> pv<span class="token punctuation">.</span><span class="token keyword">date</span> <span class="token operator">=</span> <span class="token string">&#39;2008-03-03&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span>
<span class="line"><span class="token comment">#多表连接</span></span>
<span class="line"><span class="token comment">#最大的表放最右边，性能最好</span></span>
<span class="line"><span class="token keyword">INSERT</span> OVERWRITE <span class="token keyword">TABLE</span> pv_friends</span>
<span class="line"><span class="token keyword">SELECT</span> pv<span class="token punctuation">.</span><span class="token operator">*</span><span class="token punctuation">,</span> u<span class="token punctuation">.</span>gender<span class="token punctuation">,</span> u<span class="token punctuation">.</span>age<span class="token punctuation">,</span> f<span class="token punctuation">.</span>friends</span>
<span class="line"><span class="token keyword">FROM</span> page_view pv <span class="token keyword">JOIN</span> <span class="token keyword">user</span> u <span class="token keyword">ON</span> <span class="token punctuation">(</span>pv<span class="token punctuation">.</span>userid <span class="token operator">=</span> u<span class="token punctuation">.</span>id<span class="token punctuation">)</span> </span>
<span class="line"><span class="token keyword">JOIN</span> friend_list f <span class="token keyword">ON</span> <span class="token punctuation">(</span>u<span class="token punctuation">.</span>id <span class="token operator">=</span> f<span class="token punctuation">.</span>uid<span class="token punctuation">)</span></span>
<span class="line"><span class="token keyword">WHERE</span> pv<span class="token punctuation">.</span><span class="token keyword">date</span> <span class="token operator">=</span> <span class="token string">&#39;2008-03-03&#39;</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>抽样</strong></p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code class="language-sql"><span class="line"><span class="token comment">#仅查询某些桶中的内容</span></span>
<span class="line"><span class="token comment">#假设表pv_gender_sum有100个桶，则下面语句中取第3个</span></span>
<span class="line"><span class="token comment">#语法为BUCKET x OUT OF y</span></span>
<span class="line"><span class="token comment">#y必须为桶数量的因子</span></span>
<span class="line"><span class="token keyword">INSERT</span> OVERWRITE <span class="token keyword">TABLE</span> pv_gender_sum_sample</span>
<span class="line"><span class="token keyword">SELECT</span> pv_gender_sum<span class="token punctuation">.</span><span class="token operator">*</span></span>
<span class="line"><span class="token keyword">FROM</span> pv_gender_sum TABLESAMPLE<span class="token punctuation">(</span>BUCKET <span class="token number">3</span> <span class="token keyword">OUT</span> <span class="token keyword">OF</span> <span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>运行Map/Reduce脚本</strong></p><div class="language-sql line-numbers-mode" data-highlighter="prismjs" data-ext="sql"><pre><code class="language-sql"><span class="line"><span class="token keyword">FROM</span> <span class="token punctuation">(</span></span>
<span class="line">     <span class="token keyword">FROM</span> pv_users</span>
<span class="line">     MAP pv_users<span class="token punctuation">.</span>userid<span class="token punctuation">,</span> pv_users<span class="token punctuation">.</span><span class="token keyword">date</span></span>
<span class="line">     <span class="token keyword">USING</span> <span class="token string">&#39;map_script&#39;</span></span>
<span class="line">     <span class="token keyword">AS</span> dt<span class="token punctuation">,</span> uid</span>
<span class="line">     CLUSTER <span class="token keyword">BY</span> dt<span class="token punctuation">)</span> map_output</span>
<span class="line"></span>
<span class="line"> <span class="token keyword">INSERT</span> OVERWRITE <span class="token keyword">TABLE</span> pv_users_reduced</span>
<span class="line">     REDUCE map_output<span class="token punctuation">.</span>dt<span class="token punctuation">,</span> map_output<span class="token punctuation">.</span>uid</span>
<span class="line">     <span class="token keyword">USING</span> <span class="token string">&#39;reduce_script&#39;</span></span>
<span class="line">     <span class="token keyword">AS</span> <span class="token keyword">date</span><span class="token punctuation">,</span> count<span class="token punctuation">;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div>`,61)]))}const i=n(l,[["render",t]]),r=JSON.parse('{"path":"/bigdata/Hive%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0.html","title":"Hive学习笔记","lang":"en-US","frontmatter":{"title":"Hive学习笔记","sidebar":"heading"},"git":{"updatedTime":1750240340000,"contributors":[{"name":"dongyz8","username":"dongyz8","email":"dongyz8@gdii-yueyun.com","commits":2,"url":"https://github.com/dongyz8"}],"changelog":[{"hash":"ad8fc1a188d6829c38676e985c8e2097211af10d","time":1750240340000,"email":"dongyz8@gdii-yueyun.com","author":"dongyz8","message":"commit"},{"hash":"7f927643cf84678c68bdb606a341073959279ad4","time":1734073104000,"email":"dongyz8@gdii-yueyun.com","author":"dongyz8","message":"commit"}]},"filePathRelative":"bigdata/Hive学习笔记.md"}');export{i as comp,r as data};
