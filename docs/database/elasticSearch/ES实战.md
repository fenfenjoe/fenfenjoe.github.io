---
title: ES实战
---

# ES实战

### 如何保证MYSQL数据表与ES索引的数据一致性

【需求描述】  
我在mysql数据库有一张表A，为了加快搜索速度，将数据迁移到了ES。  
但表A仍然会有增量数据进来，对于这些增量数据，要如何保证数据写进了MYSQL后，也会写进ES呢？  

【解决方案】  

1. 数据双写
2. MQ异步同步
3. 基于Binlog实现数据同步（Canal）


【数据双写】  

**原理**：在程序中，在写入数据时，先写入数据到Mysql，然后再写入到ES。  
**优点**：实现简单，时效性高  
**缺点**：硬编码问题严重（每个表都要重写一次）；如果服务或ES宕机，会有数据丢失风险  


【MQ异步同步】  

**原理**：在程序中，在写入数据时，先写入数据到Mysql，然后再写入一条消息到MQ，通过MQ告诉ES需要进行数据同步。  
**优点**：  
  - 这个方案最直接的点就是性能高，并且实现了业务的解耦合，并且可以利用 MQ 的重试机制，在写入失败的时候进行重试，降低了数据丢失的风险。  
  - 这样还支持多个数据源的写入，提高了扩展性，不会出现由于单个数据源写入异常从而导致其他数据源写入受到影响的问题。  
**缺点**：  
  - 硬编码问题，在接入新的数据源的时候需要实现新的消费者代码，代码侵入性较强
  - 引入了消息队列，提高了运维的成本，增加了系统的复杂程度
  - 可能出现延时问题，因为消息队列是异步消费模型，用户写入的数据不一定可以马上看到结果，有一定的延迟。


【Canal（基于Binlog实现数据同步）】  

**原理**：
  - Mysql的主节点会将增删改操作都写入binlog日志
  - Canal伪装成Mysql的从节点，订阅Mysql的binlog日志
**优点**：  
  - 没有代码侵入，没有硬编码
  - 原有的系统没有任何变化，可以实现无感知，性能较高
  - 业务解耦合，这个和消息队列是差不多实现思路的，不过这个不需要关注原来系统的业务实现