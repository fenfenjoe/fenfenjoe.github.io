---
title: 实战笔记
---

# 实战笔记

## 1. keyword 与 text

对于ID值（比如用户ID、商品ID），使用```keyword```类型而非```text```类型

## 2. 深分页

**查询时避免深分页**
   - 正常查询：使用 ```from + size```，如果页数很大时，效率急剧下降
   - 深度分页查询：建议使用```search_after```参数

## 3. 多字段的使用

多字段的意思是：在新建索引时，可以为字段**建立多种索引结构**。

```json
{
  "product_name": "iPhone 15 Pro Max"
}
```
这个 product_name 字段，你可能希望：
- 能进行全文搜索（搜 "iphone" 或 "pro"）
- 能进行精确匹配（完全匹配 "iPhone 15 Pro Max"）
- 能用于排序和聚合

那么在新建索引时，你可以这样：

```json
PUT /ecommerce
{
  "mappings": {
    "properties": {
      "product_name": {
        "type": "text",           // 用于全文搜索
        "analyzer": "ik_max_word",
        "fields": {
          "keyword": {
            "type": "keyword",    // 用于精确匹配、排序、聚合
            "ignore_above": 256
          },
          "pinyin": {
            "type": "text",       // 用于拼音搜索
            "analyzer": "pinyin"
          }
        }
      }
    }
  }
}
```

当你想全文搜索时：
```json
GET /ecommerce/_search
{
  "query": {
    "match": {
      "product_name": "苹果手机"  // 可以匹配到，因为分词为["苹果", "手机"]
    }
  }
}
```

当你想精确匹配时：
```json
GET /ecommerce/_search
{
  "query": {
    "term": {
      "product_name.keyword": "苹果iPhone 15 Pro Max手机"  // 必须完全匹配
    }
  }
}
```

当你想用拼音匹配时：
```json
GET /ecommerce/_search
{
  "query": {
    "match": {
      "product_name.pinyin": "pingguo"  // 通过拼音搜索
    }
  }
}
```

当你想聚合搜索(group by)、排序时：
```json
GET /ecommerce/_search
{
  "aggs": {
    "categories": {
      "terms": {
        "field": "category.keyword"  // 按分类聚合
      }
    }
  },
  "sort": [
    {
      "product_name.keyword": "asc"  // 按产品名排序
    }
  ]
}

```